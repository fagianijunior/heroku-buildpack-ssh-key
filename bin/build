#!/bin/bash

set -e

echo "-----> Install heroku-buildpack-ssh-key"

if [[ -z $BUILDPACK_SSH_KEY ]]; then
    echo "       Did you forget to set BUILDPACK_SSH_KEY?"
    exit 1
fi

if [[ -z $BUILDPACK_SSH_HOST ]]; then
  BUILDPACK_SSH_HOST=*
fi

mkdir -p /workspace/.ssh
chmod 700 /workspace/.ssh

# create the ssh config
echo "Host $BUILDPACK_SSH_HOST" >> /workspace/.ssh/config
if [[ $BUILDPACK_SSH_USER ]]; then
  echo "   User $BUILDPACK_SSH_USER" >> /workspace/.ssh/config
fi
echo "   IdentityFile /workspace/.ssh/id_rsa" >> /workspace/.ssh/config
echo "   UserKnownHostsFile /dev/null" >> /workspace/.ssh/config
echo "   StrictHostKeyChecking no" >> /workspace/.ssh/config
echo "   LogLevel ERROR" >> /workspace/.ssh/config
echo "-----> Installed SSH key from BUILDPACK_SSH_KEY"

# install the ssh key
ssh-keyscan -H github.com >> /workspace/.ssh/known_hosts 2> /dev/null

echo "-----BEGIN RSA PRIVATE KEY-----" > /workspace/.ssh/id_rsa
sed -e 's/^"//' -e 's/"$//' -e 's/\\n/\n/g' <<<"$BUILDPACK_SSH_KEY" >> /workspace/.ssh/id_rsa
echo "-----END RSA PRIVATE KEY-----" >> /workspace/.ssh/id_rsa

chmod 600 /workspace/.ssh/id_rsa